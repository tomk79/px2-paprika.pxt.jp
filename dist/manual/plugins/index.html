<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<title>プラグイン | Pickles 2</title>

<meta property="og:site_name" content="Pickles 2" />
<meta property="og:title" content="プラグイン | Pickles 2" />
<meta property="og:type" content="blog" />
<meta property="og:url" content="http://pickles2.pxt.jp/manual/plugins/" />
<meta property="og:image" content="http://pickles2.pxt.jp/common/images/og_image.png" />
<link rel="canonical" href="http://pickles2.pxt.jp/manual/plugins/" />
<link rel="icon" href="../../common/images/favicon.png" type="image/png" />
<meta name="apple-mobile-web-app-capable" content="no" /><meta name="format-detection" content="telephone=no" /><link rel="apple-touch-icon" href="../../common/images/apple-touch-icon.png" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<meta name="keywords" content="" />
		<meta name="description" content="" />

 
<!-- jQuery -->
<script src="../../common/scripts/jquery-1.10.1.min.js" type="text/javascript"></script>

<!-- Bootstrap -->
<link rel="stylesheet" href="../../common/styles/bootstrap/css/bootstrap.min.css">
<script src="../../common/styles/bootstrap/js/bootstrap.min.js"></script>

<!-- px2style -->
<link rel="stylesheet" href="../../common/px2style/dist/styles.css" type="text/css" />
<script src="../../common/px2style/dist/scripts.js"></script>

<!-- Contents Stylesheets -->
<link rel="stylesheet" href="../../common/styles/contents.css" type="text/css" />

<!-- Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-3100892-11', 'auto');
  ga('send', 'pageview');
</script>

		<!-- Adobe Typekit -->
		<script src="https://use.typekit.net/erd0xqv.js"></script>
		<script>try{Typekit.load({ async: true });}catch(e){}</script>

		<!-- Bootstrap Theme -->
		<link rel="stylesheet" href="../../caches/p/theme/pickles/styles/bootstrap-theme.min.css">
		<link rel="stylesheet" href="../../caches/p/theme/pickles/styles/theme.css">

		<!-- Font Awesome -->
		<link rel="stylesheet" href="../../caches/p/theme/pickles/libs/font-awesome-4.6.3/css/font-awesome.min.css" />

		<!-- highlight.js -->
		<link rel="stylesheet" href="../../caches/p/theme/pickles/libs/highlight.js/styles/github.css">
		<script src="../../caches/p/theme/pickles/libs/highlight.js/highlight.pack.js"></script>
		<script>
			$(document).ready(function() {
				$('pre code').each(function(i, block) {
					hljs.highlightBlock(block);
				});
			});
		</script>

		<script>
			// Adobe Typekit
			$(function(){
				var mutObs = new MutationObserver(function(records, observer){
					// console.log('MutationObserver() callback');
					// console.log(records);
					// console.log(observer);

					for( var idx in records ){
						var $tgt = $(records[idx].target);
						// $tgt.find('h1,h2,h3,h4,h5,h6')
						// 	.removeClass('tk-ryo-gothic-plusn')
						// 	.removeClass('tk-skolar-sans-latin')
						// 	.addClass('tk-ryo-gothic-plusn')
						// ;
						$tgt.find('.theme_welcome h1').removeClass('tk-ryo-gothic-plusn').addClass('tk-skolar-sans-latin');
						$tgt.find('.theme_welcome p').addClass('tk-ryo-gothic-plusn');

						// $tgt.find('.theme_header').addClass('tk-ryo-gothic-plusn');
						// $tgt.find('.theme_footer').addClass('tk-ryo-gothic-plusn');
						// $tgt.find('.theme_breadcrumb').addClass('tk-ryo-gothic-plusn');
						$tgt.find('.theme_si').removeClass('tk-ryo-gothic-plusn').addClass('tk-skolar-sans-latin');
					}

				});
				mutObs.observe($('body').get(0), {
					childList: true,
					subtree: true
				});

			});
		</script>
	</head>
	<body class="default">
		<header class="theme_header" id="page_top">
			<div class="container">
				<p class="theme_si"><a href="../../"><img src="../../caches/p/theme/pickles/images/logo_2017.svg" alt="Pickles 2" /></a></p>
				<div class="theme_shouldernavi">
<ul><li><a href="../../developers/">開発者向けの情報</a></li></ul>				</div>
				<div class="theme_globalnavi">
<ul><li><a href="../../overview/about/">はじめに</a></li><li><a href="../../download/">ダウンロード</a></li><li><a href="../" class="current">使い方</a></li><li><a href="../../tools/">ツール・リソース</a></li><li><a href="../../blog/">BLOG</a></li><li><a href="../../usergroups/">ユーザーグループ</a></li></ul>
				</div>
			</div>
		</header>
		<div class="theme_mainblock">
			<div class="container theme_common_navi_frame">
				<div class="row">
					<div class="col-sm-9">
						<div class="theme_breadcrumb"><ul><li><a href="../../">HOME</a></li><li><a href="../">使い方</a></li><li><span>プラグイン</span></li></ul></div>
						<h1>プラグイン</h1>


						<div class="contents">
<p>Pickles 2 には、プラグインを組み込む機能があります。</p>

<!-- == autoindex == -->
<div style="margin:2em 5%; border:1px solid #bbb; padding:1em; background:rgba(124, 124, 124, 0.05); border-radius:5px;">
<div style="margin:0; padding:0; text-align:center; font-weight:bold;">INDEX</div><ul style="margin:0; padding:0 0 0 2em;"><li style="list-style-type:disc; display:list-item;"><a href="#hash_プラグインを利用する">プラグインを利用する</a><ul style="margin:0; padding:0 0 0 2em;"><li style="list-style-type:disc; display:list-item;"><a href="#hash_1._composer.json_に、パッケージ情報を設定する">1. composer.json に、パッケージ情報を設定する</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_2._composer_update_を実行する">2. composer update を実行する</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_3._config.php_を更新する">3. config.php を更新する</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_プラグインの種類と実行のタイミング">プラグインの種類と実行のタイミング</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_PXコマンドとテーマ">PXコマンドとテーマ</a></li></ul></li><li style="list-style-type:disc; display:list-item;"><a href="#hash_プラグインを開発する">プラグインを開発する</a><ul style="margin:0; padding:0 0 0 2em;"><li style="list-style-type:disc; display:list-item;"><a href="#hash_プラグインPHPのロード">プラグインPHPのロード</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_呼び出し側の設定">呼び出し側の設定</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_プラグイン側の処理">プラグイン側の処理</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_bowl_とコンテンツの加工処理">bowl とコンテンツの加工処理</a></li></ul></li><li style="list-style-type:disc; display:list-item;"><a href="#hash_プラグインを公開する">プラグインを公開する</a><ul style="margin:0; padding:0 0 0 2em;"><li style="list-style-type:disc; display:list-item;"><a href="#hash_どこに公開するのか？">どこに公開するのか？</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_公開するための設定">公開するための設定</a></li>
<li style="list-style-type:disc; display:list-item;"><a href="#hash_Packagist_に登録">Packagist に登録</a></li></ul>
</li></ul>
</div>
<!-- / == autoindex == -->


<span id="hash_プラグインを利用する"></span><h2>プラグインを利用する</h2>

<p>プラグインは、次の手順で組み込みます。</p>

<ol>
<li><code>composer.json</code> の <code>require</code> にプラグインパッケージ情報を設定する</li>
<li>コマンド <code>$ composer update</code> を実行し、プラグインパッケージをインストールする</li>
<li><code>px-files/config.php</code> の <code>$conf-&gt;funcs</code> にプラグインを設定する</li>
</ol>

<span id="hash_1._composer.json_に、パッケージ情報を設定する"></span><h3>1. composer.json に、パッケージ情報を設定する</h3>

<p><a href="https://packagist.org/" target="_blank">Packagist</a> に登録されているパッケージを利用する場合は、<code>require</code> にパッケージ名とバージョンを追加します。</p>

<pre><code>{
    "require": {
        "pickles2/px2-sitemapexcel": "2.0.*"
    }
}
</code></pre>

<p>パッケージが <a href="https://packagist.org/" target="_blank">Packagist</a> に登録されていない場合、次のように、<code>repositories</code> にパッケージのURLを設定する必要があります。</p>

<pre><code class="json">{
    "repositories": [
        {
            "type": "git",
            "url": "https://github.com/tomk79/px2-page-list-generator.git"
        }
    ],
    "require": {
        "tomk79/px2-page-list-generator": "dev-master"
    }
}
</code></pre>

<span id="hash_2._composer_update_を実行する"></span><h3>2. composer update を実行する</h3>

<p>更新したパッケージ情報を反映します。</p>

<pre><code class="bash">$ composer update
</code></pre>

<span id="hash_3._config.php_を更新する"></span><h3>3. config.php を更新する</h3>

<p>パッケージのインストールが成功したら、<code>px-files/config.php</code> に、プラグインを設定します。プラグインの設定方法やオプションは、プラグインによってそれぞれ異なります。詳しくはプラグインのドキュメントを参照してください。</p>

<p>次の記述例は、<code>config.php</code> の <code>$conf-&gt;funcs-&gt;before_sitemap</code> にプラグインを設定した例です。</p>

<pre><code>&lt;?php
return call_user_func( function(){

    /* 中略 */

    // -------- functions --------

    $conf-&gt;funcs = new stdClass;

    // funcs: Before sitemap
    // サイトマップ読み込みの前に実行するプラグインを設定します。
    $conf-&gt;funcs-&gt;before_sitemap = [
        // PX=clearcache
        'picklesFramework2\commands\clearcache::register' ,

         // PX=config
        'picklesFramework2\commands\config::register' ,

         // PX=phpinfo
        'picklesFramework2\commands\phpinfo::register' ,

        // sitemapExcel
        'tomk79\pickles2\sitemap_excel\pickles_sitemap_excel::exec'

    ];

    /* 中略 */

    return $conf;
} );
</code></pre>

<span id="hash_プラグインの種類と実行のタイミング"></span><h3>プラグインの種類と実行のタイミング</h3>

<p>プラグインには次の種類があります。</p>

<ul>
<li>before_sitemap</li>
<li>before_content</li>
<li>processor</li>
<li>before_output</li>
</ul>

<p><code>before_sitemap</code>、<code>before_content</code>、<code>before_output</code> は、Pickles2が処理するすべてのリクエストに対して適用されるプラグインです。</p>

<p><code>processor</code> は、コンテンツの拡張子によって別々のプラグインを設定することができます。</p>

<p>Pickles 2 の処理は、おおまかに次の順で行われます。</p>

<ol>
<li>環境変数、入力パラメータ、コンフィグなどの解釈・調整</li>
<li>サイトマップCSVの読み込み</li>
<li>コンテンツを処理</li>
<li>出力</li>
</ol>

<p>この流れの、それぞれの間でプラグインを実行することができます。</p>

<ol>
<li>環境変数、入力パラメータ、コンフィグなどの解釈・調整

<ul>
<li>before_sitemap</li>
</ul></li>
<li>サイトマップCSVの読み込み

<ul>
<li>before_content</li>
</ul></li>
<li>コンテンツを処理

<ul>
<li>processor (拡張子ごとに別の処理を適用)</li>
<li>before_output</li>
</ul></li>
<li>出力</li>
</ol>

<p>それぞれの実行タイミングに対して複数のプラグイン処理を配列で設定できます。 処理は、配列の先頭から順に実行されます。</p>

<span id="hash_PXコマンドとテーマ"></span><h3>PXコマンドとテーマ</h3>

<p>パラメータ <code>PX</code> で実行する<a href="../pxcommands/">PXコマンド</a>は、プラグインの1つとして組み込まれています。</p>

<p>次のサンプルのプラグインは、それぞれPXコマンドを登録するように実装されたものです。</p>

<pre><code class="php">$conf-&gt;funcs-&gt;before_sitemap = [
    // PX=clearcache
    'picklesFramework2\commands\clearcache::register' ,

     // PX=config
    'picklesFramework2\commands\config::register' ,

     // PX=phpinfo
    'picklesFramework2\commands\phpinfo::register'

];
</code></pre>

<p>テーマも同様に、processorの1つとして実装されています。次のに示すコードで設定されているのが、 テーマを処理するプラグイン <code>pickles2/px2-multitheme</code> です。</p>

<pre><code class="php">$conf-&gt;funcs-&gt;processor-&gt;html = [
    // テーマ
    'theme'=&gt;'tomk79\pickles2\multitheme\theme::exec('.json_encode([
        'param_theme_switch'=&gt;'THEME',
        'cookie_theme_switch'=&gt;'THEME',
        'path_theme_collection'=&gt;'./px-files/themes/',
        'attr_bowl_name_by'=&gt;'data-contents-area',
        'default_theme_id'=&gt;'pickles2'
]).')' ,
];
</code></pre>

<span id="hash_プラグインを開発する"></span><h2>プラグインを開発する</h2>

<p>ここでは、マークダウンコンテンツを処理する processor を例に、プラグイン開発の基礎について、処理の流れを追って説明します。</p>

<span id="hash_プラグインPHPのロード"></span><h3>プラグインPHPのロード</h3>

<p>プラグインを実装したPHPファイルのパスを <code>composer.json</code> の autoload に追記して、ロードするように設定します。</p>

<pre><code class="json">{
    "autoload": {
        "files": [
            "px-files/_sys/php/myplugin.php"
        ]
    }
}
</code></pre>

<p>追記したら、composer update を実行してください。</p>

<pre><code class="bash">$ composer update
</code></pre>

<span id="hash_呼び出し側の設定"></span><h3>呼び出し側の設定</h3>

<p>プラグインを導入する設定コードが次のサンプルです。</p>

<pre><code class="php">// px-files/config.php
$conf-&gt;funcs-&gt;processor-&gt;md = [
    // Markdown文法を処理する
    'myidentity\myplugin\myclass::myfunction' ,

    // html の処理を追加
    $conf-&gt;funcs-&gt;processor-&gt;html ,
];
</code></pre>

<p><code>$conf-&gt;funcs-&gt;processor-&gt;md</code> に設定された processor は、拡張子に <code>.md</code> が付加されたコンテンツ(例：<code>index.html.md</code> など)に対して有効です。このサンプルでは、マークダウン書式を処理した後に、HTMLに対する一般的な処理を追加するために、最後に <code>$conf-&gt;funcs-&gt;processor-&gt;html</code> を設定しています。</p>

<p>コンフィグに設定された、<code>myidentity\myplugin\myclass::myfunction</code> というメソッドが、プラグインとして呼ばれます。この設定には、名前領域とクラス名、メソッド名までが含まれた名前として与えてください。<code>static</code> に呼び出せる必要があります。</p>

<p>namespace名、クラス名、メソッド名は、制作するプラグインの機能や名前に応じて適宜付け替えてください。他のプラグインとたまたま同じ名前になってしまうとエラーの原因になりえます。namespaceの先頭に開発者の名前やID名などを含めておくとよいでしょう。</p>

<p><code>myidentity\myplugin\myclass::myfunction({"JSON":"Value"})</code> のように、引数にJSONを与えることもできます。</p>

<span id="hash_プラグイン側の処理"></span><h3>プラグイン側の処理</h3>

<p>次のコードは、受け側のプラグインの実装です。</p>

<pre><code>&lt;?php
/**
 * processor "*.md"
 */
namespace myidentity\myplugin;

/**
 * processor "*.md" class
 */
class myclass{

    /**
     * 変換処理の実行
     * @param object $px Picklesオブジェクト
     * @param object $json プラグイン設定
     */
    public static function myfunction( $px, $json ){

        foreach( $px-&gt;bowl()-&gt;get_keys() as $key ){
            $src = $px-&gt;bowl()-&gt;get_clean( $key );

            $src = \Michelf\MarkdownExtra::defaultTransform($src);

            $px-&gt;bowl()-&gt;replace( $src, $key );
        }

        return true;
    }
}
</code></pre>

<p>処理の内容を見てみます。</p>

<pre><code class="php">public static function myfunction( $px, $json ){

    /* 中略 */

    return true;
}
</code></pre>

<p>引数は、Pickles2のコアオブジェクト <code>$px</code> が渡されます。</p>

<p>この例では使用していませんが、第2引数 <code>$json</code> に、コンフィグに設定した JSON オブジェクトを受け取ることができます。</p>

<p>Pickles Framework は返却値を評価しません。このメソッドは、常に <code>true</code> を返して終了します。</p>

<span id="hash_bowl_とコンテンツの加工処理"></span><h3>bowl とコンテンツの加工処理</h3>

<p>コンテンツが生成したコードは、<code>$px-&gt;bowl()</code> オブジェクトに格納されています。</p>

<p>コンテンツコードはキーと値で構造化して管理されています。 <code>$px-&gt;bowl()-&gt;get_keys()</code> から、すべてのコンテンツのキーを取得しています。</p>

<pre><code class="php">foreach( $px-&gt;bowl()-&gt;get_keys() as $key ){

    /* 中略 */

}
</code></pre>

<p>次に、コンテンツのキーを使って、bowl からコンテンツの入出力を行います。</p>

<p><code>$px-&gt;bowl()-&gt;get_clean( $key )</code> でコンテンツコードを取り出し、<code>$px-&gt;bowl()-&gt;replace( $src, $key )</code> で格納しなおしています。</p>

<pre><code class="php">foreach( $px-&gt;bowl()-&gt;get_keys() as $key ){
    $src = $px-&gt;bowl()-&gt;get_clean( $key );

    /* 中略 */

    $px-&gt;bowl()-&gt;replace( $src, $key );
}
</code></pre>

<p>取り出してすぐのコードを格納しなおしただけでは結果は変わりません。取り出したコード <code>$src</code> を加工しているのが次の部分です。</p>

<pre><code class="php">$src = \Michelf\MarkdownExtra::defaultTransform($src);
</code></pre>

<p>この例は、マークダウン文法で書かれたコンテンツコードを受け取り、HTMLに変換して再格納しています(<a href="https://packagist.org/" target="_blank">Packagist</a>のパッケージ <a href="https://packagist.org/packages/michelf/php-markdown" target="_blank">michelf/php-markdown</a> を利用)。</p>

<span id="hash_プラグインを公開する"></span><h2>プラグインを公開する</h2>

<p>開発したプラグインを公開すれば、<code>composer</code> を通じて誰でも利用できるようになります。</p>

<span id="hash_どこに公開するのか？"></span><h3>どこに公開するのか？</h3>

<p>composer が対応していればどこでも利用可能です。<a href="https://github.com/" target="_blank">Github</a>、<a href="https://bitbucket.org/" target="_blank">Bitbucket</a> などのVCSホスティングサービスが利用できます。詳しくは <a href="https://getcomposer.org/doc/05-repositories.md" target="_blank">composer のマニュアルを参照</a>してください。</p>

<span id="hash_公開するための設定"></span><h3>公開するための設定</h3>

<p><code>composer.json</code> をリポジトリのルート階層に置き、次のように編集してください。</p>

<dl>
<dt>name</dt><dd>リポジトリ名称を設定します。他のパッケージと重複しないようユニークな名前をつけてください。</dd>
<dt>autoload</dt><dd>パッケージを利用するために必要となるPHPファイルを設定します。ここに設定されたファイルは、composer の autoload.php により自動的に読み込まれます。</dd>
<dt>description, keywords, license, authors</dt><dd>必須ではありません。パッケージに関する各種の情報を記述します。</dd>
</dl>

<span id="hash_Packagist_に登録"></span><h3>Packagist に登録</h3>

<p>作成したパッケージは、PHPのパッケージ管理サービス <a href="https://packagist.org/" target="_blank">Packagist</a> に登録すると、簡単に呼び出せるようになります。</p>

<p>Packagistへの登録は必須ではありません。登録しない場合は、利用者側が <code>composer.json</code> の <code>repository</code> にリポジトリ情報を記載することで、利用することができます。</p>
						</div>



					</div>
					<div class="col-sm-3">
						<nav class="theme_common_navi">
							<p><a href="../">使い方</a></p>
<ul>
<li><a href="../system_structure/">システムの構成</a></li>
<li><a href="../setup/">セットアップ手順</a></li>
<li><a href="../configs/">設定</a></li>
<li><a href="../sitemap/">サイトマップ編集</a></li>
<li><a href="../theme/">テーマ編集</a></li>
<li><a href="../contents/">コンテンツ編集</a></li>
<li><a href="../publish/">パブリッシュ</a></li>
<li><a href="../cmd_options/">コマンドラインオプション</a></li>
<li><a href="./" class="current">プラグイン</a></li>
<li><a href="../pxcommands/">PXコマンド</a></li>
<li><a href="../guieditor/">GUI編集</a></li>
<li><a href="../contents_manifesto/">Contents Manifesto</a></li>
<li><a href="../api_reference/">API リファレンス</a></li>
</ul>
						</nav>
					</div>
				</div><!-- /.row -->
			</div><!-- /.container -->
			<div class="container">
				<div class="theme_backtotop"><a href="#page_top"><i class="fa fa-arrow-up"></i> back to top</a></div>
				<div class="theme_breadcrumb"><ul><li><a href="../../">HOME</a></li><li><a href="../">使い方</a></li><li><span>プラグイン</span></li></ul></div>
			</div><!-- /.container -->
		</div><!-- /.theme_mainblock -->
		<footer class="theme_footer">
			<div class="theme_container">
				<nav class="theme_megafooter_navi">
<ul><li><a href="../../overview/about/">はじめに</a></li><li><a href="../../download/">ダウンロード</a></li><li><a href="../" class="current">使い方</a></li><li><a href="../../tools/">ツール・リソース</a></li><li><a href="../../blog/">BLOG</a></li><li><a href="../../usergroups/">ユーザーグループ</a></li></ul>				</nav>
			</div>
			<div class="theme_container theme_footer_shouldernavi">
<ul><li><a href="../../">HOME</a></li><li><a href="../../developers/">開発者向けの情報</a></li></ul>			</div>
			<div class="theme_container theme_footer_searcher">
				<form action="../../search/" class="form-inline">
					<div class="form-group">
						<label>サイト内検索</label>
						<input type="text" name="q" value="" class="form-control" />
						<button class="form-control">検索</button>
					</div>
				</form>
			</div>
			<div class="theme_container">
				<div class="theme_social_icons">
					<a href="https://twitter.com/pxfw" target="_blank" title="Pickles 2 on Twitter"><i class="fa fa-twitter"></i></a>
					<a href="https://github.com/pickles2" target="_blank" title="Pickles 2 on github"><i class="fa fa-github"></i></a>
				</div>
			</div>
			<div class="theme_container">
				<p style="text-align:center;">&copy;Pickles 2 Project.</p>
			</div>
		</footer>
		<script src="../../caches/p/theme/pickles/scripts/smoothScroll.js"></script>
		<script src="../../caches/p/theme/pickles/scripts/global.js"></script>
		<script src="../../caches/p/theme/pickles/scripts/jquery.sidebarFix.js"></script>
		<script type="text/javascript">
			$(window).load(function(){
				$('.theme_common_navi').sidebarFix({
					'frame': $('.theme_common_navi_frame'),
					'topBuffer': 98
				});
			});
		</script>
	</body>
</html>
